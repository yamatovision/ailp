# 会員管理機能要件定義書

## 1. 機能概要

### 目的と主な機能
- ユーザーアカウントの一元管理を行うダッシュボード
- 会員情報の表示、検索、フィルタリング
- 会員ステータスの変更（有効/お試し/無効/退会）
- 試用プランの管理（期間設定、自動無効化、通知設定）
- 外部システムとの連携のためのウェブフック設定
- 会員ごとの利用状況の確認

### 想定ユーザー
- サービス管理者
- カスタマーサポート担当者

## 2. UI要素の詳細

### 各画面の構成要素
#### ヘッダー
- サービス名表示
- ヘルプボタン
- 通知ボタン（未読通知数表示）
- 管理者プロフィールアイコン

#### メインコンテンツエリア
- ページタイトルとサブタイトル
- タブ切り替え（すべて、有効、お試し、無効/退会）
- 検索ボックス
- 会員一覧テーブル
- ページネーション

#### 会員一覧テーブル
- ID
- 名前
- メールアドレス
- ステータス（バッジ表示）
- プラン
- 登録日
- 最終ログイン日
- 作成LP数
- 行クリックで詳細表示

#### 会員詳細パネル
- 基本情報セクション（ID、名前、メール、登録日、最終ログイン、プラン、試用期限）
- 利用状況セクション（作成LP数、平均CV率、メモ）
- ウェブフック設定セクション（通知用URL設定）
- アクションボタン（メール送信、ステータス変更）

#### ウェブフック設定エリア
- グローバルウェブフックURL設定
- 通知イベント選択（登録時、ステータス変更時、退会時）
- API仕様書へのリンク

### 入力フィールドと検証ルール
- **検索フィールド**
  - 入力制限なし
  - 名前とメールアドレスに対するマッチング
- **ウェブフックURL**
  - 有効なURL形式
  - 最大文字数: 256文字
- **メモフィールド**
  - マルチライン入力
  - 最大文字数: 500文字
- **試用期限日数（グローバル設定）**
  - 数値入力のみ
  - 最小値: 1
  - 最大値: 90
  - デフォルト値: 14
- **試用期限日数（個別設定）**
  - グローバル設定が基本
  - 必要に応じて個別に上書き可能
  - 数値入力のみ
  - 最小値: 1
  - 最大値: 90

### ボタンとアクション
- **ステータス変更ボタン**
  - クリック時: ステータス変更ダイアログの表示
- **メール送信ボタン**
  - クリック時: メール作成・送信インターフェース表示
- **テスト送信ボタン**
  - クリック時: ウェブフックのテストリクエスト送信
- **API仕様書表示ボタン**
  - クリック時: API仕様書ページへの遷移

## 3. データ構造

### 扱うデータの種類と形式
#### 会員データ
```json
{
  "id": "数値",
  "name": "文字列（氏名）",
  "email": "文字列（メールアドレス）",
  "status": "文字列（'active', 'trial', 'inactive', 'withdrawn'）",
  "plan": "文字列（'basic', 'premium'）",
  "registeredDate": "ISO8601形式の日時文字列",
  "lastLoginDate": "ISO8601形式の日時文字列",
  "lpCount": "数値（作成LP数）",
  "conversionRate": "数値（平均コンバージョン率）",
  "expirationDate": "ISO8601形式の日時文字列（試用期限）",
  "customTrialPeriod": "真偽値（個別試用期間設定の有無）",
  "autoDisable": "真偽値（期限切れ後自動無効化するか）",
  "notes": "文字列（メモ）"
}
```

#### 試用プラン設定データ
```json
{
  "defaultTrialPeriod": "数値（デフォルト試用日数、1～90）",
  "notificationTiming": "数値（試用期限前の通知日数、1/3/7/0）",
  "autoDisableOnExpiry": "真偽値（期限切れ後自動無効化するか）",
  "sendNotificationEmail": "真偽値（期限切れ前にメール通知するか）",
  "customNotificationDays": "数値配列（カスタム通知日の配列、例:[1, 5, 10]）"
}
```

#### ウェブフック設定データ
```json
{
  "globalWebhookUrl": "文字列（URL）",
  "memberWebhooks": [
    {
      "memberId": "数値",
      "webhookUrl": "文字列（URL）"
    }
  ],
  "eventTypes": {
    "onRegister": "真偽値",
    "onStatusChange": "真偽値",
    "onWithdraw": "真偽値"
  }
}
```

### データの永続化要件
- 会員データはデータベースに保存
- ステータス変更の履歴を記録
- 会員ごとのメモはバージョン管理（変更履歴の保存）
- ウェブフック設定は別テーブルで管理

## 4. API・バックエンド連携

### 必要なAPIエンドポイント
#### 会員管理API
- `GET /api/members` - 会員一覧取得（フィルタリングとページネーション対応）
- `GET /api/members/:id` - 特定の会員の詳細情報を取得
- `PATCH /api/members/:id` - 会員情報更新（ステータス変更含む）
- `POST /api/members/:id/notes` - 会員メモ追加/更新
- `POST /api/members/:id/email` - 会員へのメール送信

#### 試用プラン管理API
- `GET /api/settings/trial` - 試用プラン設定の取得
- `PUT /api/settings/trial` - 試用プラン設定の更新
- `POST /api/members/:id/extend-trial` - 特定会員の試用期間延長
- `POST /api/members/expiring` - 期限切れ間近の会員一覧取得
- `POST /api/members/process-expiry` - 期限切れ会員の処理（自動無効化など）

#### ウェブフック設定API
- `GET /api/webhooks/settings` - ウェブフック設定取得
- `PUT /api/webhooks/settings` - グローバルウェブフック設定更新
- `PUT /api/webhooks/members/:id` - 会員ごとのウェブフック設定更新
- `POST /api/webhooks/test` - ウェブフックテスト送信

### リクエスト/レスポンス形式
#### 会員一覧取得
**リクエスト**:
```
GET /api/members?status=active&page=1&limit=10&search=山田
```

**レスポンス**:
```json
{
  "data": [
    {
      "id": 1,
      "name": "山田 太郎",
      "email": "yamada@example.com",
      "status": "active",
      "plan": "premium",
      "registeredDate": "2023-09-01T08:30:00Z",
      "lastLoginDate": "2023-10-21T14:45:00Z",
      "lpCount": 12,
      "conversionRate": 3.8
    },
    // 他の会員
  ],
  "meta": {
    "total": 42,
    "page": 1,
    "limit": 10,
    "totalPages": 5
  }
}
```

#### 会員ステータス変更
**リクエスト**:
```json
{
  "status": "trial",
  "expirationDate": "2023-11-20T23:59:59Z"
}
```

**レスポンス**:
```json
{
  "success": true,
  "member": {
    "id": 2,
    "status": "trial",
    "expirationDate": "2023-11-20T23:59:59Z"
  }
}
```

### ウェブフックペイロード形式
```json
{
  "event": "member.status_changed",
  "timestamp": "2023-10-22T10:30:00Z",
  "data": {
    "memberId": 2,
    "oldStatus": "active",
    "newStatus": "trial",
    "expirationDate": "2023-11-20T23:59:59Z",
    "changedBy": "admin_id"
  }
}
```

## 5. エラー処理

### 想定されるエラーケース
- APIリクエスト失敗
  - ネットワークエラー
  - サーバーエラー（500系）
  - 認証エラー（401/403）
  - リソース未発見（404）
- 会員ステータス変更エラー
  - すでに退会済みのユーザーのステータス変更
  - 有効期限の不正な設定
- ウェブフックエラー
  - 無効なURL
  - 接続タイムアウト
  - レスポンスエラー

### エラーメッセージと回復方法
- **ネットワークエラー**: 「サーバーに接続できませんでした。インターネット接続を確認してください。」
  - 再試行ボタンを表示
- **認証エラー**: 「セッションが切れました。再度ログインしてください。」
  - ログインページへのリダイレクト
- **ステータス変更エラー**: 「会員ステータスを変更できませんでした。有効なステータスかご確認ください。」
  - エラー詳細の表示と修正ガイド
- **ウェブフックテストエラー**: 「ウェブフックテストに失敗しました。URLの形式と接続先を確認してください。」
  - エラー詳細とURLの入力フォームの再表示

## 6. パフォーマンス要件

### 応答時間の目標
- 初回ページロード: 2秒以内
- 会員一覧表示: 1秒以内
- 会員詳細表示: 500ms以内
- ステータス変更: 2秒以内
- 検索クエリ結果表示: 500ms以内

### 同時接続数や負荷対策
- 会員一覧のページネーション（デフォルト10件/ページ）
- API呼び出しの最適化（必要な情報のみ取得）
- データのキャッシュ利用（統計情報などの頻繁に変更されないデータ）
- 長時間実行される処理（メール一斉送信など）の非同期化
- スロットリング実装（短時間での多量リクエスト制限）

## 7. セキュリティ要件

### 認証・認可の方法
- JWTベースの認証システム
- 管理者権限の確認（一般ユーザーは会員管理画面へのアクセス不可）
- セッションタイムアウト（一定時間操作がない場合は再認証要求）

### データ保護の考慮点
- すべてのAPIリクエストはHTTPS経由
- 個人情報の適切な処理
  - 画面上の個人情報表示は必要最小限に
  - ログファイルへの個人情報記録を制限
- データベースの暗号化
- CSRFトークンによるクロスサイトリクエストフォージェリ対策
- アクションログの記録（誰がいつどのアカウントを変更したか）

## 8. 拡張性と将来の機能

### 将来追加予定の機能
- 会員の一括インポート/エクスポート機能
- 詳細なアクティビティログ
- ステータス変更の自動化ルール設定
- 会員セグメント機能
- カスタムフィールド追加機能

### 拡張性への配慮
- モジュール設計によるコンポーネントの再利用性
- プラグインアーキテクチャによる機能拡張のサポート
- 多言語対応のための国際化（i18n）対応
- 設定駆動型のUI構成（管理者が表示項目などをカスタマイズ可能）

## 9. ウェブフック連携の詳細

### サポートするイベント
- `member.registered` - 新規会員登録時
- `member.status_changed` - 会員ステータス変更時
- `member.withdrawn` - 会員退会時
- `member.plan_changed` - 会員プラン変更時
- `member.trial_expiring` - 会員の試用期限が近づいた時
- `member.trial_expired` - 会員の試用期限が切れた時
- `member.trial_extended` - 会員の試用期限が延長された時

### セキュリティ対策
- 署名付きリクエスト（HMAC認証）
- IPアドレス制限オプション
- 共有シークレットの管理
- リトライ機能（一時的な障害時）

### 通知設定の柔軟性
- イベントごとの有効/無効設定
- 会員ごとの個別設定
- グローバル設定の継承ルール